PREFIX fun:<http://w3id.org/sparql-generate/fn/>
PREFIX iter:<http://w3id.org/sparql-generate/iter/>
PREFIX foaf:<http://xmlns.com/foaf/0.1/>
PREFIX crm:<http://erlangen-crm.org/current/>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX ipato:<http://www.univ-tours.fr/ipato#>
PREFIX bf: <http://id.loc.gov/ontologies/bibframe/>
PREFIX schema: <https://schema.org/>
PREFIX dbo: <http://dbpedia.org/ontology/>
PREFIX frbr: <http://purl.org/vocab/frbr/core#>
PREFIX skos:<http://www.w3.org/2004/02/skos/core#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX dcelement:<http://purl.org/dc/elements/1.1/>
GENERATE {

?document_uri
a ?output;
dcelement:title ?document_title;
ipato:OWLDataProperty_00000006 ?identifier;
ipato:OWLObjectProperty_00000016 ?subject_output;
ipato:OWLObjectProperty_00000013 ?author_uri;
ipato:OWLObjectProperty_00000013 ?author_org_uri;
ipato:OWLObjectProperty_00000014 ?creation_place_uri;
ipato:OWLObjectProperty_00000015 ?editor_uri;
dcterms:created ?creation_date;
bf:ShelfMark ?cote;
ipato:OWLObjectProperty_00000012 ?repository_uri;
ipato:OWLObjectProperty_00000012 ?custody_city_uri;
ipato:OWLObjectProperty_00000012 ?custody_country_uri;
schema:url ?url.

?author_uri
a crm:E21_Person;
foaf:firstName ?author_firstName;
foaf:lastName ?author_lastName;
ipato:OWLObjectProperty_00000017 ?author_role_uri.

?author_role_uri
a bf:Role.

?author_org_uri
a crm:E40_Legal_Body;
skos:prefLabel ?author_org_name.

?editor_uri
a crm:E21_Person;
foaf:firstName ?editor_firstName;
foaf:lastName ?editor_lastName.

?creation_place_uri
a dbo:City;
skos:prefLabel ?creation_place_name.

?repository_uri
a dbo:Archive;
skos:prefLabel ?repository_name;
crm:P89_falls_within ?custody_city_uri.

?custody_city_uri
a dbo:City;
skos:prefLabel ?custody_city_name;
crm:P89_falls_within ?custody_country_uri.

?custody_country_uri
a dbo:Country;
skos:prefLabel ?custody_country_name.
}

SOURCE<data/in/metadata_renumar_test2.xml> AS ?source
ITERATOR iter:XPath (?source, "/searchRetrieveResponse/documents/document") AS ?document
ITERATOR iter:XPath (?document, "/document/author") AS ?author
ITERATOR iter:XPath (?document, "/document/author/*[namespace-uri()='http://id.loc.gov/ontologies/bibframe/' and local-name()='role']") AS ?author_role
ITERATOR iter:XPath (?document, "/document/renumar_editor") AS ?editor

WHERE {

BIND(fun:XPath(?document,"/document/*[namespace-uri()='http://purl.org/dc/terms/' and local-name()='type']/text()") AS ?doc_type)
BIND(IF(?doc_type = "Lettre", ipato:OWLClass_00000010,
              IF(?doc_type = 'Registre', ipato:OWLClass_00000016,
                  IF(?doc_type = 'Minute_notariale', ipato:OWLClass_00000013,
                     IF(?doc_type = 'Lettre_close', ipato:OWLClass_00000011,
                      IF(?doc_type='Acte_privé',OWLClass_00000008,
                        IF(?doc_type='Expédition_notariale',OWLClass_00000009,
                         IF(?doc_type='Lettre_de_cachet',OWLClass_00000017,
                           IF(?doc_type='Lettres_patentes',OWLClass_00000012,
                            IF(?doc_type='Registre_de_délibération',OWLClass_00000014,
                             IF(?doc_type='Registre_particulier_de_comptes',OWLClass_00000015,
                         crm:E31_Document))))))))))   AS   ?output )

BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?document,"/document/*[namespace-uri()='http://purl.org/dc/terms/' and local-name()='subject']/text()"))) AS ?doc_subject_uri)
BIND(fun:XPath(?document,"/document/*[namespace-uri()='http://purl.org/dc/terms/' and local-name()='subject']/text()") AS ?doc_subject)
BIND(IF(?doc_subject = "Vente", ipato:OWLNamedIndividual_00000073,
              IF(?doc_type = "Accord", ipato:OWLNamedIndividual_00000018,
                  IF(?doc_type = "Acte de notoriété", ipato:OWLNamedIndividual_00000019,
                     IF(?doc_type = "Assignation à comparaître", ipato:OWLNamedIndividual_00000020,
                         ?doc_subject_uri) )))   AS   ?subject_output)


BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?document,"/document/file/*[namespace-uri()='http://purl.org/dc/terms/' and local-name()='identifier']/text()"))) AS ?document_uri)
BIND(fun:XPath(?document, "/document/*[namespace-uri()='http://purl.org/dc/terms/' and local-name()='title']/text()") AS ?document_title)
BIND(fun:XPath(?document, "/document/file/*[namespace-uri()='https://schema.org/' and local-name()='url']/text()") AS ?url)
BIND(fun:XPath(?document,"/document/file/*[namespace-uri()='http://purl.org/dc/terms/' and local-name()='identifier']/text()") AS ?identifier)


BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?author,"/author/*[namespace-uri()='http://purl.org/dc/terms/' and local-name()='creator']/text()"))) AS ?author_uri)
BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?author_role,"/*[namespace-uri()='http://id.loc.gov/ontologies/bibframe/' and local-name()='role']/text()"))) AS ?author_role_uri)
BIND(fun:XPath(?author,"/author/*[namespace-uri()='http://xmlns.com/foaf/0.1/' and local-name()='firstName']/text()") AS ?author_firstName)
BIND(fun:XPath(?author,"/author/*[namespace-uri()='http://xmlns.com/foaf/0.1/' and local-name()='lastName']/text()") AS ?author_lastName)


BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?author,"/author/*[namespace-uri()='http://id.loc.gov/ontologies/bibframe/' and local-name()='organization']/text()"))) AS ?author_org_uri)
BIND(fun:XPath(?author,"/author/*[namespace-uri()='http://id.loc.gov/ontologies/bibframe/' and local-name()='organization']/text()") AS ?author_org_name)


BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?document,"/document/renumar_editor/*[namespace-uri()='https://schema.org/' and local-name()='editor']/text()"))) AS ?editor_uri)
BIND(fun:XPath(?editor,"/renumar_editor/*[namespace-uri()='http://xmlns.com/foaf/0.1/' and local-name()='firstName']/text()") AS ?editor_firstName)
BIND(fun:XPath(?editor,"/renumar_editor/*[namespace-uri()='http://xmlns.com/foaf/0.1/' and local-name()='lastName']/text()") AS ?editor_lastName)


BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?document,"/document/creation/*[namespace-uri()='http://dbpedia.org/ontology/' and local-name()='city']/text()"))) AS ?creation_place_uri)
BIND(fun:XPath(?document,"/document/creation/*[namespace-uri()='http://dbpedia.org/ontology/' and local-name()='city']/text()") AS ?creation_place_name)

BIND(fun:XPath(?document,"/document/creation/*[namespace-uri()='http://purl.org/dc/terms/' and local-name()='created']/text()") AS ?creation_date)

BIND(fun:XPath(?document,"/document/custody/*[namespace-uri()='http://id.loc.gov/ontologies/bibframe/' and local-name()='shelfMark']/text()") AS ?cote)

BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?document,"/document/custody/*[namespace-uri()='http://id.loc.gov/ontologies/bibframe/' and local-name()='organization']/text()"))) AS ?repository_uri)
BIND(fun:XPath(?document,"/document/custody/*[namespace-uri()='http://id.loc.gov/ontologies/bibframe/' and local-name()='organization']/text()") AS ?repository_name)

BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?document,"/document/custody/*[namespace-uri()='http://dbpedia.org/ontology/' and local-name()='city']/text()"))) AS ?custody_city_uri)
BIND(fun:XPath(?document,"/document/custody/*[namespace-uri()='http://dbpedia.org/ontology/' and local-name()='city']/text()") AS ?custody_city_name)

BIND(IRI(CONCAT("http://www.univ-tours.fr/ipato#",fun:XPath(?document,"/document/custody/*[namespace-uri()='http://dbpedia.org/ontology/' and local-name()='country']/text()"))) AS ?custody_country_uri)
BIND(fun:XPath(?document,"/document/custody/*[namespace-uri()='http://dbpedia.org/ontology/' and local-name()='country']/text()") AS ?custody_country_name)

}
